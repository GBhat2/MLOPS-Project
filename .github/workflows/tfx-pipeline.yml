name: Pipeline

on: push

env:
  PROJECT_ID: ${{ secrets.GCE_PROJECT }}
  GCE_INSTANCE: my-githubactions-vm  
  GCE_INSTANCE_ZONE: us-central1-a
  
jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
 
    - name: Install requirements
      run: pip install -r requirements.txt
      shell: bash
        
  build_image:
    needs: lint
    runs-on: ubuntu-latest
    steps:
      - name: Show Environment'
        uses: actions/checkout@v3
        
      - name: Set up GCloud
        uses: 'google-github-actions/setup-gcloud@v0'
      
      - run: |-
         gcloud --quiet auth configure-docker
         
      - name: Build
        run: |-
          docker build --tag "gcr.io/$PROJECT_ID/$GCE_INSTANCE-image:$GITHUB_SHA" .
    
     # - run: |
       #  gcloud config set project ${{ secrets.GCP_PROJECT_ID }}
       #  gcloud auth configure-docker
        # gcloud info
      #- name: Build and tag image
       # run: docker build -t "gcr.io/${{ secrets.GCP_PROJECT_ID }}/${{ env.APPLICATION_NAME }}:latest" .
    #- name: Push to GCP image registry
     # run: docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/${{ env.APPLICATION_NAME }}:latest
 # test_image:
   # needs: [build_image]
   # runs-on: ubuntu-latest
   # steps:
   # - name: Set up GCloud
   #   uses: GoogleCloudPlatform/github-actions/setup-gcloud@master
    #  with:
     #   version: '2.298.2'
       # service_account_email: ${{ secrets.GCP_SERVICE_ACCT_EMAIL }}
       # service_account_key: ${{ secrets.GCP_SERVICE_ACCT_KEY }}
   # - run: |
      #  gcloud config set project ${{ secrets.GCP_PROJECT_ID }}
       # gcloud config set run/region ${{ secrets.GCP_REGION }}
       # gcloud auth configure-docker
       # gcloud info
      
   # - name: Run unit tests in container
    #  run: docker run "gcr.io/${{ secrets.GCP_PROJECT_ID }}/${{ env.APPLICATION_NAME }}:latest" -m unittest --verbose --failfast
      
      
  #deploy:
    #needs: [test_image]
   # runs-on: ubuntu-latest
   # steps:
   # - name: Set up GCloud
    #  uses: GoogleCloudPlatform/github-actions/setup-gcloud@master
     # with:
      #  version: '274.0.1'
      #  service_account_email: ${{ secrets.GCP_SERVICE_ACCT_EMAIL }}
       # service_account_key: ${{ secrets.GCP_SERVICE_ACCT_KEY }}
   # - run: |
       # gcloud config set project ${{ secrets.GCP_PROJECT_ID }}
       # gcloud config set run/region ${{ secrets.GCP_REGION }}
       # gcloud info
        
    #- name: Deploy to Cloud Run
     # run: gcloud run deploy ${{ env.APPLICATION_NAME }} --image=gcr.io/${{ secrets.GCP_PROJECT_ID }}/${{ env.APPLICATION_NAME }}:latest --platform=managed --allow-unauthenticated

